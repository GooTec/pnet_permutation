# PNET robustness

## Folders

(Not all of these folders are included in the git repository.)

- `data`: output files generated by the scripts in this repository
- `doc`: project documentation
- `docker`: files for creating a Docker container with PNET installed
- `literature`: relevant publications
- `plots`: generated plots
- `pnet_data`: patches and data files required for setting up PNET
- `renv`: R environment data
- `scripts`: R scripts



## Preparation

Download the provided Docker container from the GitHub Container registry:

```bash
docker pull ghcr.io/csbg/pnet-container
```

Download the [MSK-IMPACT 2017](https://www.nature.com/articles/nm.4333) dataset:

```bash
wget https://cbioportal-datahub.s3.amazonaws.com/msk_impact_2017.tar.gz
mkdir -p pnet_data/msk_impact_2017
tar xzf msk_impact_2017.tar.gz -C pnet_data/msk_impact_2017
```


## Run experiments

Generally, each experiment comprises the following steps:

1. Load PNET input data via `load_data_[dataset].R`.
2. Optionally, modify input data via `modify_data_[technique].R`.
3. Run PNET via Docker using the provided bash script `run_pnet_docker.sh [experiment]`.

Within each experiment, results from each run are saved in a subfolder indicating the two random seeds used (e.g., `0_0`).

`utils.R` is required by all data preparation scripts.


### Original setup

Run PNET with the original setup as described in the publication.

```bash
Rscript scripts/load_data_original.R
./run_pnet_docker.sh pnet_original
```


### Deterministic inputs

Input data is modified so that presence of mutation and copy number amplification is perfectly correlated with class label 1 (copy number deletion is always 0).

```bash
Rscript scripts/load_data_original.R
Rscript scripts/modify_data_deterministic.R
./run_pnet_docker.sh pnet_deterministic
```


### Shuffled labels

Shuffle training/test labels using uniform class frequencies.

```bash
Rscript scripts/load_data_original.R
Rscript scripts/modify_data_shuffled.R
./run_pnet_docker.sh pnet_shuffled
```


### MSK-IMPACT 2017

https://www.nature.com/articles/s41467-021-27017-w

Most frequent cancer types:

1. Non-Small Cell Lung Cancer (1668)
2. Breast Cancer (1337)
3. Colorectal Cancer (1007)
4. Prostate Cancer (717)


```bash
Rscript scripts/load_data_mskimpact.R
./run_pnet_docker.sh mskimpact_all

Rscript scripts/load_data_mskimpact.R "Non-Small Cell Lung Cancer"
./run_pnet_docker.sh mskimpact_nsclc

Rscript scripts/load_data_mskimpact.R "Non-Small Cell Lung Cancer"
Rscript scripts/modify_data_shuffled.R
./run_pnet_docker.sh mskimpact_nsclc_shuffled

Rscript scripts/load_data_mskimpact.R "Non-Small Cell Lung Cancer"
Rscript scripts/modify_data_deterministic.R
./run_pnet_docker.sh mskimpact_nsclc_deterministic

```


## Analyze results

After each run, the following files are copied from the PNET output folders:

- `analysis/extracted/node_importance_graph_adjusted.csv` (renamed to `node_importance.csv`): contains node importance scores, with the following columns:
  - (first, unnamed): node name
  - coef: original node importance scores
  - coef_graph: indegree plus outdegree of node
  - coef_combined: adjusted node importance score (= coef / coef_graph if coef_graph > mean(coef_graph) + 5 sd(coef_graph) in the respective layer)
  - coef_combined_zscore: scaled coef_combined
  - coef_combined2: z(z(coef_graph) - z(coef))
  - layer: layer of the node
- `_logs/p1000/pnet/onsplit_average_reg_10_tanh_large_testing/P-net_ALL_testing.csv` (renamed to `predictions_test.csv`): predictions for the test set, with the following columns:
  - (first, unnamed): sample name
  - pred: predicted class (unfortunately, encoded by a double 1.0 or 0.0)
  - pred_scores: probability of the predicted class
  - y: true class (encoded as integer 1 or 0)
- `_logs/p1000/pnet/onsplit_average_reg_10_tanh_large_testing/P-net_ALL_training.csv` (renamed to `predictions_train.csv`): predictions for the training set (same columns as above)

`plot_figures.R` generates all figures shown in the publication. `styling.R` is required by this script.



## Appendix: How to build the PNET Docker image

The folder `docker` contains everything needed for building a Docker image with PNET installed:

- `Dockerfile`: instructions for assembling the image
- `environment_pnet.yml`: conda environment specification
- `patch_seeds.diff`: patch that allows to change the random seed for PNET
- `run_pnet.sh`: script for running PNET; used as entrypoint in the container
- `setup.sh`: executed during image assembly; installs PNET (with input data) and conda


Build and deploy the image via

```bash
docker build --tag ghcr.io/csbg/pnet-container .
docker push ghcr.io/csbg/pnet-container:latest
```



## Appendix: Description of files required by PNET

- `genes/`: only the genes present in both of the following two files will be analyzed:
            (a) `tcga_prostate_expressed_genes_and_cancer_genes.csv`
            (b) `HUGO_genes/protein-coding_gene_with_coordinate_minimal.txt`
                 (TSV, no column names; meaning of columns: chromosome, start, end, gene name)
- `pathways/`:
  - `pathways_short_names.xlsx`: short pathway names for figure labels
  - `Reactome/ReactomePathways.gmt`:
    genes associated with Reactome pathways;
    TSV, no column names, variable number of columns:
    (1) pathway name
    (2) reactome id
    (3) type (unused)
    (4ff) associated genes
  - `Reactome/ReactomePathways.txt`:
    TSV mapping Reactome ids to names;
    loaded by PNET but apparently not used (?)
  - `Reactome/ReactomePathwaysRelation.txt`:
    TSV specifying the Reactome pathway hierarchy as edge list;
    columns indicate parent and child;
    only human pathways are used (i.e., the child id has to start with "HSA")
- `prostate/`
  - `processed/`
    - `P1000_final_analysis_set_cross_important_only.csv`: mutation data;
      first column contains sample name,
      remaining columns represent genes,
      cells indicate number of mutations;
      data is preprocessed to a binary matrix, indicating presence/absence
      of at least one mutation (i.e., 1 if original >= 1)
    - `P1000_data_CNA_paper.csv`: CNV data;
      first column (unnamed) contains sample name,
      remaining columns represent genes,
      cells indicate copy number status;
      data is preprocessed to two binary matrices:
      one indicates presence of copy number amplification (1 if original > 1.5),
      the other indicates presence of CN deletion (1 if original < -1.5)
    - `response_paper.csv`: input labels, two columns:
                            (1) id – sample name
                            (2) response – sample label (1 = metastatic tumor)
  - `splits/`: splits of input data; all files have three columns:
               (1) [unnamed] – running number starting at zero
               (2) id – sample name
               (3) response – sample label (column is NOT used by PNET!)
    - `test_set.csv`: samples in the test set
    - `training_set_0.csv`: samples in the training set
    - `validation_set.csv`: samples in the validation set
