# PNET robustness

## Folders

(Not all of these folders are included in the git repository.)

- `data`: output files generated by the scripts in this repository
- `doc`: project documentation
- `literature`: relevant publications
- `plots`: generated plots
- `pnet_data`: patches and data files required for setting up PNET
- `pnet_prostate_data`: clone of the PNET repository; can be deleted
- `renv`: R environment data



## Setup PNET

Clone the git repository and change `pipeline/one_split.py` and `train/run_me.py` to allow selection of random seeds:

```bash
git clone https://github.com/marakeby/pnet_prostate_paper.git
cd pnet_prostate_paper
git checkout -b pnet-robustness 2b16264
git apply ../pnet_data/patch_seeds.diff
git commit -a -m "changes code for PNET robustness tests"
conda env create --name pnet_env --file=environment.yml
```

Download [data files](https://drive.google.com/uc?id=17nssbdUylkyQY1ebtxsIw5UzTAd0zxWb&export=download) and move the decompressed folder `_database` into `pnet_prostate_paper`. 



## Run experiments

Set up the environment:

``` bash
conda activate pnet_env
export PYTHONPATH=$PWD/pnet_prostate_paper:$PYTHONPATH
```

Generally, each experiment comprises two steps:
1. Prepare PNET input data via `prepare_[experiment name].R`.
2. Run PNET via `run_pnet.sh [experiment name]`.

Within each experiment, results from each run are saved in a subfolder indicating the two random seeds used (e.g., `0_0`). `common_functions.R` is required by the `prepare_*.R` scripts.


### Original setup

Run PNET with the original setup as described in the publication.

```bash
Rscript prepare_original.R
./run_pnet.sh original
```


### Deterministic inputs

Input data is modified so that presence of mutation and copy number amplification is perfectly correlated with class label 1 (copy number deletion is always 0).

```bash
Rscript prepare_deterministic.R
./run_pnet.sh deterministic
```


### Shuffled labels

Shuffle training/test labels using uniform class frequencies.

```bash
Rscript prepare_shuffled.R
./run_pnet.sh shuffled
```


## Analyze results

After each run, the following files are copied from the PNET output folders:

- `analysis/extracted/node_importance_graph_adjusted.csv` (renamed to `node_importance.csv`): contains node importance scores, with the following columns:
  - (first, unnamed): node name
  - coef: original node importance scores
  - coef_graph: indegree plus outdegree of node
  - coef_combined: adjusted node importance score (= coef / coef_graph if coef_graph > mean(coef_graph) + 5 sd(coef_graph) in the respective layer)
  - coef_combined_zscore: scaled coef_combined
  - coef_combined2: z(z(coef_graph) - z(coef))
  - layer: layer of the node
- `_logs/p1000/pnet/onsplit_average_reg_10_tanh_large_testing/P-net_ALL_testing.csv` (renamed to `predictions_test.csv`): predictions for the test set, with the following columns:
  - (first, unnamed): sample name
  - pred: predicted class (unfortunately, encoded by a double 1.0 or 0.0)
  - pred_scores: probability of the predicted class
  - y: true class (encoded as integer 1 or 0)
- `_logs/p1000/pnet/onsplit_average_reg_10_tanh_large_testing/P-net_ALL_training.csv` (renamed to `predictions_train.csv`): predictions for the training set (same columns as above)

`plot_figures.R` generates all figures shown in the publication. `styling.R` is required by this script.



## Appendix: Description of files required by PNET

- `genes/`: only the genes present in both of the following two files will be analyzed:
            (a) `tcga_prostate_expressed_genes_and_cancer_genes.csv`
            (b) `HUGO_genes/protein-coding_gene_with_coordinate_minimal.txt`
                 (TSV, no column names; meaning of columns: chromosome, start, end, gene name)
- `pathways/`:
  - `pathways_short_names.xlsx`: short pathway names for figure labels
  - `Reactome/ReactomePathways.gmt`:
    genes associated with Reactome pathways;
    TSV, no column names, variable number of columns:
    (1) pathway name
    (2) reactome id
    (3) type (unused)
    (4ff) associated genes
  - `Reactome/ReactomePathways.txt`:
    TSV mapping Reactome ids to names;
    loaded by PNET but apparently not used (?)
  - `Reactome/ReactomePathwaysRelation.txt`:
    TSV specifying the Reactome pathway hierarchy as edge list;
    columns indicate parent and child;
    only human pathways are used (i.e., the child id has to start with "HSA")
- `prostate/`
  - `processed/`
    - `P1000_final_analysis_set_cross_important_only.csv`: mutation data;
      first column contains sample name,
      remaining columns represent genes,
      cells indicate number of mutations;
      data is preprocessed to a binary matrix, indicating presence/absence
      of at least one mutation (i.e., 1 if original >= 1)
    - `P1000_data_CNA_paper.csv`: CNV data;
      first column (unnamed) contains sample name,
      remaining columns represent genes,
      cells indicate copy number status;
      data is preprocessed to two binary matrices:
      one indicates presence of copy number amplification (1 if original > 1.5),
      the other indicates presence of CN deletion (1 if original < -1.5)
    - `response_paper.csv`: input labels, two columns:
                            (1) id – sample name
                            (2) response – sample label (1 = metastatic tumor)
  - `splits/`: splits of input data; all files have three columns:
               (1) [unnamed] – running number starting at zero
               (2) id – sample name
               (3) response – sample label (column is NOT used by PNET!)
    - `test_set.csv`: samples in the test set
    - `training_set_0.csv`: samples in the training set
    - `validation_set.csv`: samples in the validation set
